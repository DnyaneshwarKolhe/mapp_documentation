## One-on-one
+ **KT Provided By**: Amal Santhosh, Basil Eldhose
+ **KT Received By**: Dnyaneshwar Kolhe, Sahil Tamang
+ **Documentation Created By**: Dnyaneshwar Kolhe
### Overview
The One-on-One Module is designed to facilitate structured conversations between managers and employees, ensuring clear communication, feedback exchange, and professional growth discussions. This module allows scheduling, tracking, and documenting conversations, ensuring accountability and continuity in employee development.
### User Guide
- Here are all the UI components in one on one
  - **Instant 1:1** *button*: This button will open a popup to select participant and title, and then a button to  start the instant one-on-one. If you click that, it will go to the **call window**
  - **Schedule 1:1** *button*: This button will open form to schedule one-on-one. We'll discuss about this in details in an upcoming chapter.
  - **Search bar**: This is to search any specific one-on-one
  - **Tab view for 1:1**: Here you can see all the meetings, there are three tabs: Previous, Today/This week and Upcoming
  - **Bookmarks**: Comming soon
  - **Quick links**: This contains multiple links as follows: Action Items of previous 1:1, Agenda for next 1:1, Prepare for next 1:1, 1:1 Effectiveness, Learn more about 1:1s
    - Out of these, only 1:1 Effectiveness is active. Rest all links are comming soon.
#### Schedule 1:1
- When you click schedule 1:1, you will see form to schedule the 1:1
- The form has the following things
  - **Participant**: Select participant with whom you want to schedule 1:1
  - **Title**: Title of your 1:1
  - **When**: Select the date and time of your 1:1
  - **Duration**: Add the number of hours for which you want to schedule 1:1
  - **Series**: It's a toggle and when you enable it, you can see a dropdown to select Recurrence.
    - Recurrence have Does not Repeat, Every weekday(Mon-Fri), Daily, Weekly, Monthly, Custom
    - When you select any of these options except Does not repeat, it will open a popup for setting recurrence
    - On this popup, you need to select start date, end date, and repeat every, which depends on the option you selected from recurrence, like 
      - In every weekday(Mon-Fri) case, you can see 1 week and you will see an option to select the days you can select and save.
      - In that 1 Week case, week is a dropdown so from here you can select Day, Week and Month which covers options daily weekly and monthly
      - In case of day you didn't get an option to select days in a week, you can change the day to specify how many days after every meeting, the next meeting will be. you can select the date and save the meeting.
      - And in case of the month, you get an option to either add a date or add a day of a particular week, and then you can save it
      - In case when you selected custom, it's the same as day, where you can select between day, date or month.
    - Once you selected recurrence, you can add agenda and either go back or save the meeting.
  - **Agenda**: You can add agenda about what you are going to discuss in that meeting.
    - Agenda has title, checkbox to check if it's related to OKR and description box
    - If you check "Related to participant OKRS?" checkbox, it will give you the option to select OKR from the participant's OKR list
    - You can delete the added Agenda, and if you have selected OKR in the agenda, you get an option to see that OKR
  - **Go back** *button*: If you don't want to create a meeting, you can click go back to discard the changes
  - **Save** *button*: You can save the details to create the meeting

You can see your scheduled one-on-one in any of the tabs.
#### Tab view for 1:1
- **Previous**:
  - Here you can see the meetings which are either done or the date is passed.
  - You can filter out meetings using the following filters, when no filter is applied, you can see all the meetings
    - **Past week**: Meeting from last week and before
    - **Past month**: Meethings from the last month
    - **Past year**: Meetings from the last year
    - **This year**: Meetings from this year
    - **custom**: You can select custom date range to see meetings in that date range
  - Here you can see the meetings card, which has date, time, title, participants, button to add next meeting, button to view agenda and button to view meeting details
  - When you click the button to view the agenda, it will show the agenda in a popup
  - The add next button will take you to the meeting scheduling page
- **This week/Today**: 
  - This tab is like a dropdown, initially selected tab is this week, and the Today tab is in the dropdown
  - When this week tab is selected, you can see all pending meetings scheduled for this week
  - You can select daily from the dropdown to see all the meetings scheduled but not done for today
  - This also shows meeting in the form of a card, similar to the preview section, only the next button is changed to start using which you can start the meeting and the view button is changed to the edit button
  - This edit button is visible to only the creator of the meeting, using which you can edit occurrence or series(if it is part of a series meeting)
  - You can click start, which will take you to the meeting page
- **Upcomming**:
  - In this tab, you can see all the meetings scheduled for the next week
  - The filters are the same as the previous, only the past is changed to the next
  - The card is the same as Today/This week, only the start button is changed to view using which we can view meeting details
#### 1:1 detail view
- The detail page shows info about the meeting
- At the top of the page, you can see the title, and below that, the date is shown
- On both sides of the date, you can see arrows using which you can go to the previous or next occurrence if the meeting is a series
- Below that you can see meeting participants
- In the last part, you can see three sections
  - First section contains Agenda, feedback and Action item, which will be visible when you click to the respective tab
  - Second section is for notes, the dropdown is there using which you can select a participant to see his notes
  - Last section is for summary, you can see summary and below the summary there is a button to view transcript.

These are all the details you can see in the detail section
#### Meeting page
- When you start instant 1:1 or scheduled 1:1, This page will be opened
- At the top, you have 1:1 title and below that, the date of the 1:1
- If you have any previous 1:1, you can see the details for that 1:1, which are the same as the detail view.
- If there are multiple 1:1s done previously, you can change the date to see details of the previous 1:1
- This section will not be available if you don't have a previous 1:1
- Next section is the current 1:1 section, which has 2 parts
- First one consists of two sections
  - In the first section, you can add agenda, action items, notes, and you can give feedback to the participant
  - If your meeting has an agenda, you will get tips related to that agenda.
  - Second part is for call and transcript from where you can start the call, turn video, audio on and off, and see and manage transcription if you are not using calling feature
  - **The call feature works as follows**
    - When you click the call button, you will see a popup with instructions, you can read those and continue with the call
    - Caller sees only calling icon, whereas receiver can see receive as well as reject icon, they can either receive or reject the call
    - When the call is connected, the transcript, fullscreen, mic, camera, and end call buttons are available there.
    - Once the call ended, you will see a message and the go back button.
    - If you ended the call, the message is **I have ended your call. See you!** but if it is ended by another person the message will be **[Persons name] has ended the call** 
    - Go back button will take you to the start screen where you can start a call or transcript again
  - **Transcription feature working**
    - You can click a transcript icon to start a transcript
    - After clicking, you can see two buttons, start and go back
    - Once you click start, the recipient and you will see this message **[name of user who started] has started transcription**, and on stop **[name of user who stopped] has stopped transcription**
    - After transcription is started, both buttons will disappear, and the stop button you will see using which you can stop the recording
    - If one person is started with transcription, it will be started in both ends and the same for stop as well
    - and in this section you will also see each other's messages.
    - You can go back to the call and transcript page using the go back button
  - When you start the call, you'll see some instructions which you need to follow. These instructions are as follows
    - Both users should be logged in to the MApp application.
    - Both users should start the same one-on-one meeting.
    - Once the application is ready, a call button appears. The user doesn't have to do anything.
    - However, if an issue occurs and calling is not available for some technical reason like the internet connection, the user will be notified by a message.
    - Upon refreshing the browser, Call will get disconnected.
- The second part of current 1:1 section is about section about corrusponding person which is powered by soul
- In this section, you can see user's top 5 values, strengths, knowledge and skills, personalities, and impact narrative
- If the participant hasn't completed these things, you can see msg that No report found
- At the end of the page, you have two buttons
  - **Go back**: Go back to the tab section again without completing
  - **I'm done**: Finish the meeting, once clicked you can see confirmation popup and after that there is one more popupn which says that you have completed 1:1 successfully and asks if you want to schedule next 1:1
  - Finally you get the feedback popup. and your meeting is done.
### Technical Breakdown
#### rrule
- We are following rrule to schedule recurrence meetings which you can find in OccurrenceModal.jsx.
- The RRULE (Recurrence Rule) defines how one-on-one meetings or recurring events are scheduled based on frequency, interval, specific days, and end date.

- RRULE Format:
  ```
  RRULE:FREQ=WEEKLY;INTERVAL={interval};BYDAY={weekdays};UNTIL={until}
  ```
  - FREQ=WEEKLY → The event repeats weekly.
  - INTERVAL={interval} → Defines how often the event repeats (e.g., every 2 weeks if INTERVAL=2).
  - BYDAY={weekdays} → Specifies the days of the week (e.g., MO,WE,FR for Monday, Wednesday, and Friday).
  - UNTIL={until} → Defines the end date (in YYYYMMDDT000000Z format).
- Example
  ```
  RRULE:FREQ=WEEKLY;INTERVAL=1;BYDAY=MO,WE,FR;UNTIL=20250304T235959Z
  ```
#### How call features work
- **Call Feature Overview**
  - Uses **WebRTC for peer-to-peer connections**.
  - **WebSocket for real-time communication**.
  - Supports **audio/video calls with transcription**.
  - Uses **TURN/STUN servers for NAT traversal** when users are on different networks.
  - If transcription is enabled, **audio is recorded, processed, and converted to text**.

- **Call Initialization**
  1. **User clicks 'Start Meeting'** → A **WebRTC peer connection** is established.
  2. **WebSocket Connection Established** → Handles **session initiation, status updates, and live notifications**.
  3. **TURN/STUN Server Check** → Determines whether **direct P2P is possible or if a relay is needed**.
  4. **Media Permissions Requested** → Browser requests **microphone & camera access**.
  5. **Media Stream Established** → The **user’s video & audio** are initialized.
  6. **Connection Event Handling** → Ensures **both participants receive session updates**.

  - **Code Snippet for WebSocket Initialization**
    ```javascript
    const socket = new WebSocket("wss://yourserver.com/call");
    socket.onopen = () => console.log("WebSocket Connected");
    socket.onmessage = (event) => handleIncomingMessages(event);
    socket.onerror = (error) => console.error("WebSocket Error", error);
    socket.onclose = () => console.log("WebSocket Disconnected");
    ```

- **Media Handling and Peer Connection**
  - Once the call starts, **WebRTC handles media streaming**, and **WebSockets manage call events**.

  - **Media Device Access**
    ```javascript
    navigator.mediaDevices.getUserMedia({ audio: true, video: true })
    .then((stream) => {
        localVideo.srcObject = stream;
        peerConnection.addStream(stream);
    })
    .catch((error) => console.error("Media access error: ", error));
    ```

  - **WebRTC Peer Connection Setup**
    ```javascript
    const peerConnection = new RTCPeerConnection({
        iceServers: [
            { urls: "stun:stun.l.google.com:19302" },
            { urls: "turn:your.turn.server", username: "user", credential: "pass" }
        ]
    });
    ```

- **Handling ICE Candidates**
  ```javascript
  peerConnection.onicecandidate = (event) => {
      if (event.candidate) {
          socket.send(JSON.stringify({ type: "candidate", candidate: event.candidate }));
      }
  };
  ```

- **Call Transcription Handling**\
If transcription is enabled:
  1. **Audio is recorded and sent to the backend.**
  2. **Backend processes and transcribes audio using AI.**
  3. **WebSocket sends live transcription back to the front-end.**

  - **Recording Audio and Sending to Backend**
    ```javascript
    const mediaRecorder = new MediaRecorder(stream);
    let audioChunks = [];

    mediaRecorder.ondataavailable = (event) => {
        audioChunks.push(event.data);
    };

    mediaRecorder.onstop = () => {
        const audioBlob = new Blob(audioChunks, { type: "audio/wav" });
        const formData = new FormData();
        formData.append("audio", audioBlob);
        
        fetch("https://yourserver.com/transcribe", {
            method: "POST",
            body: formData
        }).then(response => response.json())
          .then(data => displayTranscription(data.text));
    };
    ```

  - **Receiving Transcription Data via WebSocket**
    ```javascript
    socket.onmessage = (event) => {
        const data = JSON.parse(event.data);
        if (data.type === "transcription") {
            displayTranscription(data.text);
        }
    };
    ```

- **Call Termination**
  1. **User clicks 'End Call'**.
  2. **Peer connection is closed**.
  3. **Media tracks are stopped to release system resources**.
  4. **WebSocket sends termination event to the other participant**.
  5. **The session moves to 'Previous Meetings'**.

  - **Code Snippet for Ending a Call**
    ```javascript
    function endCall() {
        peerConnection.close();
        stream.getTracks().forEach(track => track.stop());
        socket.send(JSON.stringify({ type: "call-ended" }));
    }
    ```

- **Error Handling and Debugging**
  - **WebSocket Failure Handling** → If disconnected, it attempts to reconnect.
  - **TURN Server Requirement** → If direct connection fails, a relay is used.
  - **Audio/Video Permission Errors** → The UI displays an error if access is denied.
  - **Transcription API Failures** → Retries sending recorded audio if the first attempt fails.

> [!TIP]
> src/modules/one-on-one/components/OccuranceModal.jsx
